<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
  <title>Control de Consumo de Energ√≠a ‚ö°</title>

  <!-- App icons (SVG favicon + maskable png generado al vuelo) -->
  <link rel="icon" href='data:image/svg+xml;utf8,
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
    <rect width="64" height="64" rx="12" fill="#facc15"/>
    <path d="M38 6 14 36h12l-4 22 32-36H42l4-16z" fill="#111827"/>
  </svg>'>
  <meta name="theme-color" content="#0b1220" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Consumo Energ√≠a">

  <style>
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; max-width: 100%; overflow-x: hidden; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans";
      line-height: 1.4;
      word-wrap: break-word;
      overflow-wrap: anywhere;
      background: #0b1220;
      color: #e5e7eb;
    }
    :root{
      --gap: 12px;
      --radius: 14px;
      --border: 1px solid #223045;
      --shadow: 0 1px 0 rgba(0,0,0,0.2), 0 10px 28px rgba(0,0,0,0.35);
      --bg: #0b1220;
      --bg-page: #0b1220;
      --card: #0f172a;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --brand: #0ea5e9;
      --accent: #facc15;
      --danger: #ef4444;
      --safe: #16a34a;
    }
    .hero{
      background: linear-gradient(180deg, var(--bg) 0%, #111827 100%);
      color: #f8fafc;
      padding: 14px 12px;
      box-shadow: var(--shadow);
      position: sticky; top: 0; z-index: 30;
      width: 100%;
    }
    .wrap{ max-width: 1100px; margin: 0 auto; display:flex; align-items:center; gap:10px; min-width: 0; }
    .logo{
      width: 40px; height: 40px; border-radius: 12px; background: var(--accent);
      display:grid; place-items:center; box-shadow: 0 6px 18px rgba(250,204,21,.35); flex: 0 0 auto;
    }
    .logo svg{ width: 22px; height: 22px; }
    .title{ font-weight: 900; font-size: clamp(1.02rem, 2.2vw + .7rem, 1.6rem); display:flex; gap:8px; align-items:center; min-width:0; }
    .subtitle{ color: #cbd5e1; font-size: .95rem; white-space: normal; }
    .app{ max-width: 1100px; margin: 0 auto; display:grid; gap:var(--gap); padding: 12px 12px 88px; background: var(--bg-page); }
    .card, details.custom{ background: var(--card); border: var(--border); border-radius: var(--radius); padding: 14px; box-shadow: var(--shadow); color: var(--text); }
    h2{ font-size: clamp(1rem, 1.2vw + .7rem, 1.1rem); margin: 0 0 8px }
    .muted{ color: var(--muted); font-size: .95rem; }
    label{ font-weight: 600; font-size: 1rem; display:block; margin-bottom: 6px; }
    input[type="date"], input[type="number"], input[type="text"], select{
      width: 100%; border: var(--border); border-radius: 12px; padding: 14px; font-size: 1.02rem; color: var(--text); background: #0b1220;
    }
    input::placeholder{ color:#94a3b8; }
    input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }
    .grid{ display:grid; grid-template-columns: 1fr; gap: var(--gap); }
    .row{ display:grid; grid-template-columns: 1fr; gap: var(--gap); align-items:end; }
    @media (min-width: 760px){ .grid-6{ grid-template-columns: repeat(6, 1fr); } .row-4{ grid-template-columns: repeat(4, 1fr); } .grid-2{ grid-template-columns: repeat(2, 1fr); } }
    .flex{ display:flex; gap: var(--gap); align-items:center; flex-wrap: wrap; min-width: 0; }
    .grow{ flex: 1 1 auto; min-width: 0; }
    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; padding: 14px 16px; border-radius: 14px; min-height:48px; border: 1px solid #1f2937; background: var(--brand); color: #fff; font-weight: 800; cursor:pointer; text-decoration:none; user-select:none; max-width: 100%; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
    .btn.secondary{ background:#334155; color:#e2e8f0; border-color:#475569; }
    .btn.danger{ background: var(--danger); border-color:#b91c1c; }
    .btn.icon{ padding: 12px 12px; min-width:48px; }
    .btn.success{ background: var(--safe); border-color:#15803d; }
    details.custom{ overflow: hidden; padding: 0; }
    details.custom > summary{ list-style: none; cursor: pointer; padding: 14px; background: linear-gradient(180deg, #0f172a, #111827); font-weight: 800; display:flex; align-items:center; gap:10px; border-bottom: var(--border); user-select: none; color:#e2e8f0; }
    details.custom > summary::-webkit-details-marker{ display:none; }
    .caret{ transition: transform .2s ease; } details[open] .caret{ transform: rotate(90deg); }
    .panel-body{ padding: 12px; }
    table{ width: 100%; border-collapse: collapse; background: transparent; }
    thead th{ background: #111827; color:#e2e8f0; text-align:left; font-size: .98rem; padding:10px; border-bottom: var(--border); position: sticky; top:0; }
    tbody td{ padding: 10px; border-bottom: 1px solid #1f2937; font-size: 1.02rem; }
    tfoot td{ padding: 12px 10px; font-weight: 700; background: #0f172a; color:#e2e8f0; }
    .numbers{ text-align:right; font-variant-numeric: tabular-nums; }
    @media (max-width: 640px){
      table, thead, tbody, tfoot, th, td, tr{ display:block; width:100%; }
      thead{ display:none; }
      tbody tr{ background:#0f172a; border: var(--border); border-radius: 14px; box-shadow: var(--shadow); margin: 10px 0 14px; padding-bottom: 6px; }
      tbody td{ border:0; display:grid; grid-template-columns: minmax(110px, 42%) 1fr; align-items:center; padding: 10px 12px; gap: 8px; }
      tbody td::before{ content: attr(data-label); font-weight:700; color: var(--muted); }
    }
    .chart-wrap{ width: 100%; max-width: 100%; overflow: hidden; }
    canvas{ width: 100%; max-width: 100%; height: 240px; display:block; }
    .bottom-bar{ position: fixed; left: 0; right: 0; bottom: 0; background: #111827; border-top: 1px solid rgba(255,255,255,0.12); padding: 8px 10px; z-index: 50; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
    @supports (backdrop-filter: blur(8px)) { .bottom-bar{ background: rgba(17,24,39,0.9); backdrop-filter: saturate(180%) blur(10px); } }
    .footer-note{ text-align:center; color:#94a3b8; font-size:.95rem; padding: 8px 16px; }
    .toast{ position: fixed; left: 12px; right: 12px; bottom: 94px; background:#0f172a; border: var(--border); border-radius: 12px; padding: 12px; color:#e5e7eb; box-shadow: var(--shadow); z-index: 60; display:none; }
    .toast.show{ display:block; }
  </style>
</head>
<body>
  <header class="hero">
    <div class="wrap">
      <div class="logo" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M13 2 4 14h6l-2 8 12-14h-6l2-6z" fill="#111827"/>
        </svg>
      </div>
      <div class="titlebox">
        <div class="title">Control de Consumo de Energ√≠a <span aria-hidden="true">‚ö°</span></div>
        <div class="subtitle">Registro y proyecci√≥n ‚Äî <span style="color:var(--accent);font-weight:800;">local, sin instalaci√≥n</span></div>
      </div>
    </div>
  </header>

  <main class="app">
    <div class="toast" id="pwaHint">
      <strong>Instalar como app (PWA)</strong><br>
      Para que Chrome permita <em>Instalar</em>, este archivo debe abrirse desde <code>https</code> o <code>localhost</code>. GitHub Pages ya cumple esto.
      <div class="flex" style="margin-top:8px;">
        <button class="btn secondary" id="dismissHint">Entendido</button>
      </div>
    </div>

    <!-- Perfiles -->
    <div class="card" id="cardProfiles">
      <h2>Perfiles</h2>
      <div class="grid grid-6">
        <div style="grid-column: span 2;">
          <label for="selectPerfil">Seleccionar perfil guardado</label>
          <select id="selectPerfil"></select>
        </div>
        <div style="grid-column: span 2;">
          <label for="nombrePerfil">Nombre del perfil (para guardar)</label>
          <input type="text" id="nombrePerfil" placeholder="Ej. Casa, Oficina">
        </div>
        <div><label>&nbsp;</label><button class="btn w-100" id="guardarPerfil">üíæ Guardar</button></div>
        <div><label>&nbsp;</label><button class="btn secondary w-100" id="cargarPerfil">üìÇ Cargar</button></div>
        <div><label>&nbsp;</label><button class="btn secondary w-100" id="renombrarPerfil">‚úèÔ∏è Renombrar</button></div>
        <div><label>&nbsp;</label><button class="btn danger w-100" id="borrarPerfil">üóëÔ∏è Borrar</button></div>
      </div>
    </div>

    <!-- Config -->
    <div class="card" id="cardConfig">
      <h2>Configuraci√≥n del ciclo</h2>
      <div class="grid grid-6">
        <div><label for="inicio">Fecha inicio</label><input type="date" id="inicio"></div>
        <div><label for="fin">Fecha final</label><input type="date" id="fin"></div>
        <div><label for="precio">Valor kWh (COP)</label><input type="number" id="precio" inputmode="decimal" step="0.0001" min="0" placeholder="Ej. 820"></div>
        <div><label for="adicionales">Adicionales mensuales (COP)</label><input type="number" id="adicionales" inputmode="numeric" step="0.01" min="0" placeholder="Ej. 15000"></div>
        <div style="grid-column: span 2;">
          <label class="flex" style="gap:10px;"><input type="checkbox" id="prorrata" /><span>Prorratear adicionales por d√≠a</span></label>
          <p class="muted" style="margin-top:6px;">Suma <em>adicionales/d√≠as del ciclo</em> al costo de cada d√≠a; la proyecci√≥n final agrega el total mensual una sola vez.</p>
        </div>
      </div>
    </div>

    <!-- Add lectura -->
    <div class="card" id="cardAdd">
      <h2>Agregar lectura</h2>
      <div class="row row-4">
        <div><label for="fechaLectura">Fecha</label><input type="date" id="fechaLectura"></div>
        <div><label for="lectura">Lectura (kWh)</label><input type="number" id="lectura" inputmode="decimal" step="0.001" min="0" placeholder="Ej. 12543.7"></div>
        <div><label>&nbsp;</label><button class="btn success w-100" id="agregar">‚ûï Agregar</button></div>
        <div><label>&nbsp;</label><button class="btn secondary w-100" id="hoy">üìÖ Hoy</button></div>
      </div>
    </div>

    <!-- Lecturas -->
    <details class="custom" id="panelLecturas">
      <summary class="flex">
        <span class="caret">‚ñ∂</span>
        <span class="grow">Lecturas del ciclo</span>
        <span class="muted nowrap" id="badgeConteo"></span>
        <div class="flex" style="gap:6px; min-width:0;">
          <button class="btn secondary icon" id="ordenAsc" title="Orden ascendente">‚¨ÜÔ∏è</button>
          <button class="btn secondary icon" id="ordenDesc" title="Orden descendente">‚¨áÔ∏è</button>
          <button class="btn secondary icon" id="exportar" title="Exportar JSON">üßæ</button>
          <button class="btn secondary icon" id="exportarCSV" title="Exportar CSV">üìÑ</button>
          <input type="file" id="importar" accept="application/json" style="display:none;">
          <button class="btn secondary icon" id="importarBtn" title="Importar JSON">üì•</button>
        </div>
      </summary>
      <div class="panel-body">
        <table id="tabla">
          <thead>
            <tr><th>Fecha</th><th class="numbers">Lectura (kWh)</th><th class="numbers">Dif. d√≠a anterior (kWh)</th><th class="numbers">Costo del d√≠a (COP)</th><th></th></tr>
          </thead>
          <tbody></tbody>
          <tfoot><tr><td colspan="5" id="resumen">‚Äî</td></tr></tfoot>
        </table>
        <div class="muted" style="padding-top:8px;">Tip: toca una fila para editarla. Usa la ‚ùå para eliminar.</div>
      </div>
    </details>

    <!-- Chart -->
    <div class="card" id="cardChart">
      <h2>Gr√°fico de consumo diario (kWh)</h2>
      <div class="chart-wrap"><canvas id="chart" height="240" aria-label="Gr√°fico de consumo diario"></canvas></div>
      <p class="muted">L√≠nea = kWh diarios. L√≠nea punteada = promedio del ciclo.</p>
    </div>

    <!-- Proyecciones -->
    <div class="card" id="cardStats">
      <h2>Proyecciones del ciclo</h2>
      <div class="grid grid-2">
        <div>
          <ul>
            <li><span class="muted">D√≠as del ciclo:</span> <span id="diasCiclo">0</span></li>
            <li><span class="muted">D√≠as con datos:</span> <span id="diasTrans">0</span></li>
            <li><span class="muted">Consumo acumulado (kWh):</span> <span id="consumoAcum" class="numbers">0</span></li>
            <li><span class="muted">Promedio diario (kWh/d√≠a):</span> <span id="promedio" class="numbers">0</span></li>
            <li><span class="muted">Costo acumulado (parcial):</span> <span id="costoParcial" class="numbers">0</span></li>
          </ul>
        </div>
        <div>
          <ul>
            <li><span class="muted">Proyecci√≥n consumo (kWh):</span> <span id="proyKwh" class="numbers">0</span></li>
            <li><span class="muted">Proyecci√≥n costo energ√≠a (COP):</span> <span id="proyEnergia" class="numbers">0</span></li>
            <li><span class="muted">Adicionales (COP):</span> <span id="cobros" class="numbers">0</span></li>
            <li><span class="muted">Proyecci√≥n total (COP):</span> <span id="proyTotal" class="numbers">0</span></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="footer-note">‚ö° App local y offline ‚Äî <strong>copirigth Esnaider Viloria</strong></div>
  </main>

  <!-- Bottom Quick Actions -->
  <div class="bottom-bar" id="bottomBar" role="toolbar" aria-label="Acciones r√°pidas">
    <button class="btn secondary" id="btnLecturas">üìã Lecturas</button>
    <button class="btn" id="btnAgregar">‚ûï Lectura</button>
    <button class="btn secondary" id="btnProyecciones">üìä Proyecciones</button>
  </div>

  <!-- === App logic + PWA bootstrap === -->
  <script>
    (function makeAppleTouchIcon(){
      try{
        const canvas = document.createElement('canvas');
        const size = 192;
        canvas.width = size; canvas.height = size;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#facc15'; ctx.fillRect(0,0,size,size);
        ctx.fillStyle = '#111827';
        ctx.beginPath();
        ctx.moveTo(size*0.59, size*0.09);
        ctx.lineTo(size*0.22, size*0.56);
        ctx.lineTo(size*0.41, size*0.56);
        ctx.lineTo(size*0.34, size*0.92);
        ctx.lineTo(size*0.89, size*0.31);
        ctx.lineTo(size*0.62, size*0.31);
        ctx.closePath();
        ctx.fill();
        const png = canvas.toDataURL('image/png');
        const link = document.createElement('link');
        link.rel = 'apple-touch-icon'; link.href = png;
        document.head.appendChild(link);
        window.__APP_ICON__ = png;
      }catch(e){}
    })();
  </script>

  <script>
    // ===== App =====
    const $ = (sel) => document.querySelector(sel);
    const fmtNum = (n, dig=2) => isFinite(n) ? Number(n).toLocaleString('es-CO', {maximumFractionDigits: dig, minimumFractionDigits: 0}) : '‚Äî';
    const fmtMoney = (n) => isFinite(n) ? Number(n).toLocaleString('es-CO', {style:'currency', currency:'COP', maximumFractionDigits: 0}) : '‚Äî';
    const toISO = (d) => d ? new Date(d).toISOString().slice(0,10) : "";

    const state = { perfil: "Default", config: { inicio: "", fin: "", precio: 0, adicionales: 0, prorrata: false }, lecturas: [] };
    const keyPerfil = (name) => `energia.app::${name || state.perfil}`;
    const perfilesDisponibles = () => Object.keys(localStorage).filter(k => k.startsWith("energia.app::")).map(k => k.split("::")[1]);

    const guardar = () => { localStorage.setItem(keyPerfil(state.perfil), JSON.stringify({ config: state.config, lecturas: state.lecturas })); refrescarSelector(); };
    const cargar = (perfil) => {
      const raw = localStorage.getItem(keyPerfil(perfil));
      if(raw){ const data = JSON.parse(raw); state.perfil = perfil; state.config = Object.assign({inicio:"", fin:"", precio:0, adicionales:0, prorrata:false}, data.config || {}); state.lecturas = data.lecturas || []; }
      else { state.perfil = perfil; state.config = { inicio:"", fin:"", precio:0, adicionales:0, prorrata:false }; state.lecturas = []; }
      render(); refrescarSelector(perfil);
    };
    function refrescarSelector(seleccion){
      const select = $('#selectPerfil'); const perfiles = perfilesDisponibles(); select.innerHTML = "";
      if(perfiles.length === 0){ const opt = document.createElement('option'); opt.value = "Default"; opt.textContent = "Default"; select.appendChild(opt); }
      else { for(const p of perfiles){ const opt = document.createElement('option'); opt.value = p; opt.textContent = p; if((seleccion || state.perfil) === p) opt.selected = true; select.appendChild(opt);} }
    }

    const ordenarLecturasAsc = (a,b) => a.fecha.localeCompare(b.fecha);
    const ordenarLecturasDesc = (a,b) => b.fecha.localeCompare(a.fecha);
    function diferenciasOrdenadas(list){
      const ordenadas = [...list].sort(ordenarLecturasAsc); const out = [];
      for(let i=0;i<ordenadas.length;i++){ const cur = ordenadas[i]; const prev = ordenadas[i-1]; const diff = (prev) ? (Number(cur.lectura) - Number(prev.lectura)) : 0; out.push({ ...cur, diff }); }
      return out;
    }
    function diasEntre(a,b){ if(!a || !b) return 0; const ms = (new Date(b) - new Date(a)); return Math.max(0, Math.round(ms / (1000*60*60*24)) + 1); }
    function resumen(){
      const cfg = state.config; const diffs = diferenciasOrdenadas(state.lecturas);
      const consumoAcum = diffs.reduce((acc, r) => acc + (r.diff>0 ? r.diff : 0), 0);
      const diasConDatos = Math.max(0, diffs.length - 1);
      const promedio = diasConDatos > 0 ? consumoAcum / diasConDatos : 0;
      const diasTotales = diasEntre(cfg.inicio, cfg.fin);
      const proyKwh = (diasTotales>0 && promedio>0) ? promedio * diasTotales : 0;
      const proyEnergia = proyKwh * Number(cfg.precio || 0);
      const proyTotal = proyEnergia + Number(cfg.adicionales || 0);
      const prorrataDia = (cfg.prorrata && diasTotales>0) ? Number(cfg.adicionales || 0)/diasTotales : 0;
      const costoParcial = diffs.reduce((acc, r) => { const energiaDia = Math.max(0, r.diff) * Number(cfg.precio || 0); return acc + energiaDia + prorrataDia; }, 0);
      return { consumoAcum, diasConDatos, promedio, diasTotales, proyKwh, proyEnergia, proyTotal, costoParcial, prorrataDia };
    }

    function render(){
      $('#inicio').value = state.config.inicio || ""; $('#fin').value = state.config.fin || "";
      $('#precio').value = state.config.precio || ""; $('#adicionales').value = state.config.adicionales || "";
      $('#prorrata').checked = !!state.config.prorrata; $('#nombrePerfil').value = state.perfil || "Default";
      $('#badgeConteo').textContent = `(${state.lecturas.length} lecturas)`;

      const tbody = $('#tabla tbody'); tbody.innerHTML = "";
      const rows = diferenciasOrdenadas(state.lecturas);
      const diasTotales = diasEntre(state.config.inicio, state.config.fin);
      const prorrataDia = (state.config.prorrata && diasTotales>0) ? Number(state.config.adicionales || 0)/diasTotales : 0;

      for(const r of rows){
        const tr = document.createElement('tr'); const originalFecha = r.fecha;
        const tdFecha = document.createElement('td'); tdFecha.setAttribute('data-label', 'Fecha');
        const fechaInput = document.createElement('input'); fechaInput.type = 'date'; fechaInput.value = r.fecha;
        fechaInput.addEventListener('change', (e) => { const idx = state.lecturas.findIndex(x => x.fecha === originalFecha); if(idx >= 0){ state.lecturas[idx].fecha = e.target.value; guardar(); render(); } });
        tdFecha.appendChild(fechaInput);
        const tdLect = document.createElement('td'); tdLect.className = 'numbers'; tdLect.setAttribute('data-label', 'Lectura (kWh)');
        const lectInput = document.createElement('input'); lectInput.type = 'number'; lectInput.inputMode = 'decimal'; lectInput.step = '0.001'; lectInput.min = '0'; lectInput.value = r.lectura; lectInput.style.textAlign = 'right';
        lectInput.addEventListener('change', (e) => { const idx = state.lecturas.findIndex(x => x.fecha === originalFecha); if(idx >= 0){ state.lecturas[idx].lectura = Number(e.target.value); guardar(); render(); } });
        tdLect.appendChild(lectInput);
        const tdDiff = document.createElement('td'); tdDiff.className = 'numbers'; tdDiff.setAttribute('data-label', 'Dif. d√≠a anterior (kWh)'); tdDiff.textContent = fmtNum(r.diff, 3);
        const tdCosto = document.createElement('td'); tdCosto.className = 'numbers'; tdCosto.setAttribute('data-label', 'Costo del d√≠a (COP)');
        const energiaDia = Math.max(0, r.diff) * Number(state.config.precio || 0); const costoDia = energiaDia + prorrataDia; tdCosto.textContent = new Intl.NumberFormat('es-CO', {style:'currency', currency:'COP', maximumFractionDigits:0}).format(costoDia);
        const tdDel = document.createElement('td'); tdDel.setAttribute('data-label', 'Acciones');
        const del = document.createElement('button'); del.className = 'btn danger'; del.textContent = '‚ùå Eliminar'; del.style.width = '100%';
        del.addEventListener('click', () => { const idx = state.lecturas.findIndex(x => x.fecha === originalFecha); if(idx >= 0){ state.lecturas.splice(idx,1); guardar(); render(); } });
        tdDel.appendChild(del);
        tr.appendChild(tdFecha); tr.appendChild(tdLect); tr.appendChild(tdDiff); tr.appendChild(tdCosto); tr.appendChild(tdDel); tbody.appendChild(tr);
      }

      const R = resumen();
      $('#consumoAcum').textContent = fmtNum(R.consumoAcum, 3);
      $('#diasTrans').textContent = R.diasConDatos;
      $('#promedio').textContent = fmtNum(R.promedio, 3);
      $('#diasCiclo').textContent = R.diasTotales;
      $('#proyKwh').textContent = fmtNum(R.proyKwh, 3);
      $('#proyEnergia').textContent = fmtMoney(R.proyEnergia);
      $('#cobros').textContent = fmtMoney(Number(state.config.adicionales || 0));
      $('#proyTotal').textContent = fmtMoney(R.proyTotal);
      $('#costoParcial').textContent = fmtMoney(R.costoParcial);
      const msgResumen = (state.lecturas.length >= 2) ? `Entre ${rows[0]?.fecha ?? "‚Äî"} y ${rows[rows.length-1]?.fecha ?? "‚Äî"} has consumido ${fmtNum(R.consumoAcum,3)} kWh` : `Agrega otra lectura para ver diferencias, costo diario y promedio.`;
      $('#resumen').textContent = msgResumen;

      drawChart();
    }

    function drawChart(){
      const canvas = $('#chart'); if(!canvas) return;
      const ctx = canvas.getContext('2d'); const dpr = window.devicePixelRatio || 1;
      const cssWidth = canvas.clientWidth; const cssHeight = canvas.clientHeight;
      canvas.width = Math.floor(cssWidth * dpr); canvas.height = Math.floor(cssHeight * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      const diffs = diferenciasOrdenadas(state.lecturas).slice(1);
      const xs = diffs.map(d => d.fecha); const ys = diffs.map(d => Math.max(0, d.diff));
      const promedio = (ys.length ? ys.reduce((a,b)=>a+b,0) / ys.length : 0);
      const W = cssWidth, H = cssHeight; const m = {l: 44, r: 12, t: 12, b: 28};
      ctx.clearRect(0,0,W,H); ctx.strokeStyle = '#1f2937'; ctx.lineWidth = 1; ctx.strokeRect(0.5,0.5,W-1,H-1);
      if(ys.length === 0){ ctx.fillStyle = '#94a3b8'; ctx.font = '14px system-ui, -apple-system, Segoe UI, Roboto'; ctx.fillText('A√±ade lecturas para ver el gr√°fico', 14, H/2); return; }
      const maxY = Math.max(...ys) * 1.15 || 1; const minY = 0; const n = ys.length;
      const x = (i)=> m.l + ( (W - m.l - m.r) * (i/(n-1||1)) ); const y = (v)=> m.t + (H - m.t - m.b) * (1 - ( (v - minY) / (maxY - minY || 1) ));
      ctx.strokeStyle = '#1f2937'; ctx.lineWidth = 1; ctx.beginPath(); const ticks = 4;
      for(let t=0;t<=ticks;t++){ const yy = m.t + (H - m.t - m.b) * (t/ticks); ctx.moveTo(m.l, yy); ctx.lineTo(W - m.r, yy); } ctx.stroke();
      ctx.fillStyle = '#94a3b8'; ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto';
      for(let t=0;t<=ticks;t++){ const val = maxY * (1 - t/ticks); const yy = m.t + (H - m.t - m.b) * (t/ticks); ctx.fillText(fmtNum(val,2), 6, yy+4); }
      ctx.strokeStyle = '#e2e8f0'; ctx.lineWidth = 2; ctx.beginPath(); ys.forEach((v,i) => { const xx = x(i), yy = y(v); if(i===0) ctx.moveTo(xx,yy); else ctx.lineTo(xx,yy); }); ctx.stroke();
      ctx.fillStyle = '#0ea5e9'; ys.forEach((v,i)=>{ const xx = x(i), yy = y(v); ctx.beginPath(); ctx.arc(xx,yy,3,0,Math.PI*2); ctx.fill(); });
      ctx.setLineDash([6,6]); ctx.strokeStyle = '#facc15'; ctx.lineWidth = 1.5; ctx.beginPath(); ctx.moveTo(m.l, y(promedio)); ctx.lineTo(W - m.r, y(promedio)); ctx.stroke(); ctx.setLineDash([]);
      const step = Math.ceil(n / 6); ctx.fillStyle = '#94a3b8'; ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto';
      for(let i=0;i<n;i+=step){ const xx = x(i); const lbl = xs[i]?.slice(5) || ''; ctx.fillText(lbl, xx-14, H-8); }
    }
    window.addEventListener('resize', drawChart);

    // Eventos
    function syncCamposDesdeUI(){ state.config.inicio = $('#inicio').value; state.config.fin = $('#fin').value; state.config.precio = Number($('#precio').value || 0); state.config.adicionales = Number($('#adicionales').value || 0); state.config.prorrata = $('#prorrata').checked; }
    $('#btnAgregar').addEventListener('click', () => { const dt = $('#fechaLectura'); if(!dt.value) dt.value = toISO(new Date()); $('#lectura').focus({preventScroll:false}); document.getElementById('cardAdd').scrollIntoView({behavior:'smooth', block:'center'}); });
    $('#btnProyecciones').addEventListener('click', () => { document.getElementById('cardStats').scrollIntoView({behavior:'smooth', block:'start'}); });
    $('#btnLecturas').addEventListener('click', () => { const d = document.getElementById('panelLecturas'); if(!d.open) d.open = true; d.scrollIntoView({behavior:'smooth', block:'start'}); });

    $('#guardarPerfil').addEventListener('click', () => { const nombre = ($('#nombrePerfil').value || "Default").trim(); if(!nombre){ alert('Pon un nombre al perfil.'); return; } state.perfil = nombre; syncCamposDesdeUI(); guardar(); alert('Perfil guardado: ' + state.perfil); refrescarSelector(state.perfil); });
    $('#cargarPerfil').addEventListener('click', () => { const p = $('#selectPerfil').value || "Default"; cargar(p); alert('Perfil cargado: ' + p); });
    $('#borrarPerfil').addEventListener('click', () => { const p = $('#selectPerfil').value; if(!p){ alert('No hay perfil seleccionado.'); return; } if(confirm('¬øBorrar perfil \"' + p + '\" y sus datos?')){ localStorage.removeItem(keyPerfil(p)); if(p === state.perfil){ state.lecturas = []; } refrescarSelector(); const restantes = perfilesDisponibles(); cargar(restantes[0] || "Default"); } });
    $('#renombrarPerfil').addEventListener('click', () => { const actual = $('#selectPerfil').value; const nuevo = prompt('Nuevo nombre para el perfil:', actual); if(!nuevo || nuevo === actual) return; const data = localStorage.getItem(keyPerfil(actual)); if(data) localStorage.setItem(keyPerfil(nuevo), data); localStorage.removeItem(keyPerfil(actual)); cargar(nuevo); alert('Perfil renombrado a: ' + nuevo); });
    $('#selectPerfil').addEventListener('change', (e) => { const p = e.target.value; cargar(p); });

    $('#agregar').addEventListener('click', () => {
      const fecha = $('#fechaLectura').value; const lectura = Number($('#lectura').value);
      if(!fecha || !isFinite(lectura)){ alert('Completa la fecha y la lectura.'); return; }
      if(state.config.inicio && state.config.fin){ if(new Date(fecha) < new Date(state.config.inicio) || new Date(fecha) > new Date(state.config.fin)){ if(!confirm('La fecha est√° fuera del rango del ciclo. ¬øAgregar de todas formas?')) return; } }
      const idx = state.lecturas.findIndex(x => x.fecha === fecha);
      if(idx >= 0) state.lecturas[idx].lectura = lectura; else state.lecturas.push({ fecha, lectura });
      guardar(); $('#lectura').value = ""; const panel = document.getElementById('panelLecturas'); if(!panel.open) panel.open = true; render(); panel.scrollIntoView({behavior:'smooth', block:'start'});
    });
    $('#hoy').addEventListener('click', () => { $('#fechaLectura').value = toISO(new Date()); });
    $('#ordenAsc').addEventListener('click', () => { state.lecturas.sort(ordenarLecturasAsc); guardar(); render(); });
    $('#ordenDesc').addEventListener('click', () => { state.lecturas.sort(ordenarLecturasDesc); guardar(); render(); });

    $('#exportar').addEventListener('click', () => { const data = { perfil: state.perfil, config: state.config, lecturas: state.lecturas }; const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `energia_${state.perfil.replace(/\s+/g,'_')}.json`; a.click(); URL.revokeObjectURL(url); });
    $('#exportarCSV').addEventListener('click', () => {
      const diffs = diferenciasOrdenadas(state.lecturas); const diasTotales = diasEntre(state.config.inicio, state.config.fin);
      const prorrataDia = (state.config.prorrata && diasTotales>0) ? Number(state.config.adicionales || 0)/diasTotales : 0;
      const rows = [['Perfil', state.perfil], ['Inicio', state.config.inicio], ['Fin', state.config.fin], ['Valor_kWh', state.config.precio], ['Adicionales_mensuales', state.config.adicionales], ['Prorrata_por_dia', state.config.prorrata ? 'S√≠' : 'No'], [], ['Fecha','Lectura_kWh','Diferencia_kWh','Costo_dia_COP']];
      for(const r of diffs){ const energiaDia = Math.max(0, r.diff) * Number(state.config.precio || 0); const costoDia = energiaDia + prorrataDia; rows.push([r.fecha, r.lectura, r.diff, Math.round(costoDia)]); }
      const csv = rows.map(arr => arr.join(',')).join('\n'); const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `energia_${state.perfil.replace(/\s+/g,'_')}.csv`; a.click(); URL.revokeObjectURL(url);
    });
    $('#importarBtn').addEventListener('click', () => $('#importar').click());
    $('#importar').addEventListener('change', (ev) => {
      const f = ev.target.files?.[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = () => { try{ const data = JSON.parse(reader.result); if(data.config && data.lecturas){ state.perfil = data.perfil || state.perfil; state.config = Object.assign({inicio:"", fin:"", precio:0, adicionales:0, prorrata:false}, data.config || {}); state.lecturas = data.lecturas; guardar(); render(); alert('Datos importados.'); } else { alert('Archivo no v√°lido.'); } }catch(e){ alert('Error al leer JSON.'); } };
      reader.readAsText(f);
    });

    ['inicio','fin','precio','adicionales','prorrata'].forEach(id => { document.getElementById(id).addEventListener('change', () => { state.config.inicio = $('#inicio').value; state.config.fin = $('#fin').value; state.config.precio = Number($('#precio').value || 0); state.config.adicionales = Number($('#adicionales').value || 0); state.config.prorrata = $('#prorrata').checked; guardar(); render(); }); });

    (function init(){
      const perfiles = perfilesDisponibles();
      if(perfiles.length){ cargar(perfiles[0]); } else { state.perfil = "Default"; $('#fechaLectura').value = toISO(new Date()); guardar(); render(); }
      refrescarSelector(state.perfil); const d = document.getElementById('panelLecturas'); d.open = false; $('#fechaLectura').value = $('#fechaLectura').value || toISO(new Date());

      // PWA bootstrap (manifest + SW)
      const isSecureContext = location.protocol === 'https:' || location.hostname === 'localhost';
      if('serviceWorker' in navigator && isSecureContext){
        const manifest = {
          name: "Control de Consumo de Energ√≠a",
          short_name: "Consumo Energ√≠a",
          description: "Registro de lecturas y proyecci√≥n de consumo el√©ctrico. Funciona offline.",
          start_url: location.pathname + location.search + location.hash,
          scope: "./",
          display: "standalone",
          theme_color: "#0b1220",
          background_color: "#0b1220",
          icons: [ { src: window.__APP_ICON__ || "", sizes: "192x192", type: "image/png", purpose:"any maskable" } ]
        };
        const manifestBlob = new Blob([JSON.stringify(manifest)], {type:'application/manifest+json'});
        const manifestURL = URL.createObjectURL(manifestBlob);
        const link = document.createElement('link'); link.rel = 'manifest'; link.href = manifestURL; document.head.appendChild(link);

        const swCode = `
          self.addEventListener('install', (e) => {
            e.waitUntil(caches.open('energia-app-v1').then(cache => cache.addAll(['./'])));
            self.skipWaiting();
          });
          self.addEventListener('activate', (e)=>{ self.clients.claim(); });
          self.addEventListener('fetch', (e) => {
            const req = e.request;
            e.respondWith(
              caches.match(req).then(cached => cached || fetch(req).then(resp => {
                const copy = resp.clone();
                caches.open('energia-app-v1').then(c => c.put(req, copy)).catch(()=>{});
                return resp;
              }).catch(()=> cached))
            );
          });
        `.trim();
        try{
          const blob = new Blob([swCode], {type:'text/javascript'});
          const swUrl = URL.createObjectURL(blob);
          navigator.serviceWorker.register(swUrl, {scope: './'}).catch(()=>{});
        }catch(e){}
      }else{
        const el = document.getElementById('pwaHint');
        if(el && !localStorage.getItem('energia.hidePwaHint')){
          el.classList.add('show');
          document.getElementById('dismissHint').onclick = ()=>{ el.classList.remove('show'); localStorage.setItem('energia.hidePwaHint', '1'); };
        }
      }
    })();
  </script>
</body>
</html>
